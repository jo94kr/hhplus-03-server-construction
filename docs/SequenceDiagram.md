### 대기열 체크 API

> 대기열 체크와 토큰이 없을 경우 토큰을 발급한다.

```mermaid
sequenceDiagram
    autonumber
    actor 사용자
    사용자 ->>+ 대기열: 대기열 체크 API 호출 (대기열 토큰)
    break 토큰 없으면 토큰 발급
        대기열 ->> 대기열: 대기열 토큰 저장
        대기열 -->> 사용자: 대기열 토큰 정보
    end
    대기열 ->>+ 참가열: 참가열 정보 조회 (대기열 토큰)
    참가열 -->>- 대기열: 참가열 정보
    Note over 대기열, 참가열: 현재 참가열 수, ...
    alt 참가열 진입 가능
        대기열 ->> 참가열: 참가열 추가
        대기열 -->> 사용자: 진입 가능 반환
    else 참가열 진입 불가
        대기열 -->>- 사용자: 대기열 정보
        Note over 대기열, 사용자: 대기자 수, 현재 순번, ...
    end  
```    

### 대기열 토큰 만료/진입 스케쥴러

> - 프로세스 완료, 대기열 이탈 등 대기열 토큰 만료 처리
> - 주기마다 참가열의 빈 슬롯만큼 대기열을 참가열로 유입시킨다

```mermaid  
sequenceDiagram
    autonumber
    loop N초 마다 스케쥴
        스케쥴러 ->> 대기열: 대기열 토큰 만료 처리
        스케쥴러 ->> 참가열: 참가열 토큰 만료 처리
        스케쥴러 ->>+ 참가열: 참가열 정보 조회
        참가열 -->>- 스케쥴러: 참가열 정보
        스케쥴러 ->> 참가열: 참가 가능한 인원 유입
    end  
```  

### 콘서트 조회 API

```mermaid  
sequenceDiagram
    autonumber
    actor 사용자
    사용자 ->>+ 콘서트 목록 조회: 콘서트 목록 조회 요청
    콘서트 목록 조회 ->>+ 참가열: 대기열 토큰 검증
    break 유효하지 않은 토큰
        참가열 -->> 사용자: 검증 실패
    end
    참가열 -->>- 콘서트 목록 조회: 검증 성공
    콘서트 목록 조회 -->>- 사용자: 콘서트 목록  
```  

### 날짜 조회 API

```mermaid  
sequenceDiagram
    autonumber
    actor 사용자
    사용자 ->>+ 콘서트 스케쥴: 날짜 조회 요청 (콘서트 정보)
    콘서트 스케쥴 ->>+ 참가열: 대기열 토큰 검증
    break 유효하지 않은 토큰
        참가열 -->> 사용자: 검증 실패
    end
    참가열 -->>- 콘서트 스케쥴: 검증 성공
    콘서트 스케쥴 -->>- 사용자: 예약 가능한 콘서트 스케쥴  
```  

### 좌석 조회 API

```mermaid  
sequenceDiagram
    autonumber
    actor 사용자
    사용자 ->>+ 예약 가능 좌석: 좌석 조회 요청(콘서트 스케쥴 정보)
    예약 가능 좌석 ->>+ 참가열: 대기열 토큰 검증
    break 유효하지 않은 토큰
        참가열 -->> 사용자: 검증 실패
    end
    참가열 -->>- 예약 가능 좌석: 검증 성공
    예약 가능 좌석 -->>- 사용자: 예약 가능한 좌석  
```  

### 좌석 예약 API

```mermaid  
sequenceDiagram
    autonumber
    actor 사용자
    사용자 ->>+ 좌석 예약: 예약 요청 (좌석정보, 사용자 정보)
    좌석 예약 ->>+ 참가열: 대기열 토큰 검증
    break 유효하지 않은 토큰
        참가열 -->> 사용자: 검증 실패
    end
    참가열 -->>- 좌석 예약: 검증 성공
    좌석 예약 ->> 좌석 예약: 좌석 조회 (lock)
break 이미 임시 배정된 좌석
좌석 예약 -->> 사용자: 
    end
좌석 예약 ->> 좌석 예약: 좌석 임시 배정
좌석 예약 -->>- 사용자: 결제정보  
```  

### 임시 배정 좌석 만료 스케쥴러

```mermaid
sequenceDiagram
    autonumber
    loop 10초 마다 좌석 임시 배정 만료 처리
        스케쥴러 ->>+ 좌석 예약: 임시 배정 만료 좌석 처리 (5분)
    end
```

### 결제 API

```mermaid  
sequenceDiagram
    autonumber
    actor 사용자
    사용자 ->>+ 결제: 결제 요청 (결제정보)
    결제 ->>+ 좌석 예약: 유효한 좌석 체크 (좌석 배정 번호)
    좌석 예약 -->>- 결제: 유효한 좌석
    break 유효하지 않은 좌석
        결제 -->> 사용자: 결제 실패
    end
    alt 잔액 있음
        결제 ->>+ 잔액: 잔액 차감 (사용자, 결제 금액)
        잔액 -->>- 결제: 결제 성공
        결제 ->> 좌석 예약: 결제 완료 (좌석 배정 번호)
        결제 ->> 참가열: 대기열 토큰 만료 (토큰)
        결제 -->> 사용자: 예약 완료
    else 잔액 없음
        결제 ->>+ 잔액: 잔액 차감 (사용자, 결제 금액)
        잔액 -->>- 결제: 잔액 부족
        결제 -->>- 사용자: 잔액 부족
    end  
```

### 잔액 조회 API
```mermaid  
sequenceDiagram
    autonumber
    actor 사용자
    사용자 ->>+ 잔액: 잔액 조회 (사용자 정보)
    잔액 -->>+ 사용자: 잔액
```

### 잔액 충전 API
```mermaid  
sequenceDiagram
    autonumber
    actor 사용자
    사용자 ->>+ 잔액: 잔액 충전 (사용자 정보, 충전 금액)
    잔액 -->>+ 사용자: 잔액
```
